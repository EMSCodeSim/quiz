<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EMS Daily Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef7fc;
      padding: 20px;
      max-width: 650px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #0077cc;
    }
    .question-box {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .choices label {
      display: block;
      margin: 8px 0;
    }
    .feedback {
      margin-top: 10px;
      font-weight: bold;
    }
    .correct {
      color: green;
    }
    .explanation {
      color: #555;
    }
    select, button {
      margin: 10px auto;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      display: block;
    }
    button {
      background: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>EMS Daily Quiz</h1>

<label for="dateSelector">Choose quiz date:</label>
<select id="dateSelector"></select>

<form id="quizForm"></form>
<button onclick="submitQuiz()">Submit Answers</button>

<!-- Firebase + App Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
let questions = [];
let currentDate = getTodayString();

function getTodayString(offset = 0) {
  const d = new Date();
  d.setDate(d.getDate() - offset);
  return d.toISOString().split('T')[0];
}

function populateDateSelector() {
  const selector = document.getElementById("dateSelector");
  for (let i = 0; i <= 3; i++) {
    const dateStr = getTodayString(i);
    const opt = document.createElement("option");
    opt.value = dateStr;
    opt.innerText = i === 0 ? `Today (${dateStr})` : `${i} day(s) ago (${dateStr})`;
    selector.appendChild(opt);
  }
  selector.addEventListener("change", () => {
    currentDate = selector.value;
    loadQuestions();
  });
}

function loadQuestions() {
  const ref = firebase.database().ref("daily_quizzes/" + currentDate);
  ref.once("value").then(snapshot => {
    if (!snapshot.exists()) {
      document.getElementById("quizForm").innerHTML = "<p>No quiz found for this date.</p>";
      return;
    }
    questions = snapshot.val();
    displayQuestions();
  });
}

function displayQuestions() {
  const form = document.getElementById("quizForm");
  form.innerHTML = "";
  questions.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question-box";
    div.innerHTML = `
      <p>${q.question}</p>
      ${q.choices.map(choice => `
        <label><input type="radio" name="q${i}" value="${choice.charAt(0)}"> ${choice}</label>
      `).join("")}
      <div class="feedback" id="feedback${i}"></div>
    `;
    form.appendChild(div);
  });
}

function submitQuiz() {
  const results = [];
  questions.forEach((q, i) => {
    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    const feedback = document.getElementById(`feedback${i}`);
    let result = { question: q.question, selected: null, correct: q.correct };
    if (!selected) {
      feedback.innerHTML = "❌ No answer selected.";
      feedback.className = "feedback explanation";
    } else if (selected.value === q.correct) {
      feedback.innerHTML = `✅ Correct! ${q.explanation}`;
      feedback.className = "feedback correct";
      result.selected = selected.value;
      result.result = "correct";
    } else {
      feedback.innerHTML = `❌ Incorrect. ${q.explanation}`;
      feedback.className = "feedback explanation";
      result.selected = selected.value;
      result.result = "incorrect";
    }
    results.push(result);
  });

  // Submit to Firebase (anonymously)
  firebase.database().ref("quiz_submissions/" + Date.now()).set({
    date: currentDate,
    results
  });
}

// Initialize
populateDateSelector();
loadQuestions();
</script>

</body>
</html>
