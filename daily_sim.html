<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Daily Sim — Daily EMS Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --panel:#101826; --text:#eaf2ff; --muted:#b6c2ff;
      --edge:rgba(255,255,255,.12); --shadow:0 10px 30px rgba(0,0,0,.35);
      --btn:linear-gradient(135deg,#06b6d4,#6366f1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:var(--text);}
    .wrap{max-width:900px; margin:0 auto; padding:clamp(16px,3.5vw,32px)}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--text)}
    .logo{width:40px; height:40px; border-radius:12px; overflow:hidden; border:1px solid var(--edge); display:grid; place-items:center}
    .logo img{width:100%; height:100%; object-fit:cover}
    .title{line-height:1.1}
    .title b{font-size:18px}
    .tiny{font-size:12px; opacity:.75}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--edge); border-radius:18px; box-shadow:var(--shadow);}
    .hero{padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .simName{font-size:16px; font-weight:800; letter-spacing:.2px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; text-decoration:none; color:white; border:1px solid rgba(255,255,255,.16); background:var(--btn)}
    .actions{display:flex; flex-wrap:wrap; gap:8px}
    .frameWrap{margin-top:12px; height:72vh; min-height:440px}
    iframe{width:100%; height:100%; border:0; border-radius:18px; background:#0b0f14}
    .fallback{padding:16px}
    footer{margin:18px 0 8px; text-align:center; color:#cbd5e1; font-size:14px}
    footer a{color:#93c5fd; text-decoration:none; border-bottom:1px dashed rgba(147,197,253,.5)}
    footer a:hover{border-bottom-color:transparent}
  </style>

  <!-- Optional: GA (uses your site’s existing property if present) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-19DVN7NNH7"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-19DVN7NNH7');
  </script>

  <script>
    // --- CONFIG: List your available mini-apps here ---
    // slug: short id used in query param overrides, etc.
    // url: full URL to the hosted app on EMS Code Sim
    // icon: emoji for simple visual flair
    // enabled: toggle if you want to temporarily remove one from rotation
    const SIMS = [
      { slug:'bp',         title:'Blood Pressure Simulator',   url:'https://emscodesim.com/vitals/bp.html',         icon:'🩺', enabled:true },
      { slug:'pulse',      title:'Pulse Trainer',              url:'https://emscodesim.com/vitals/pulse.html',      icon:'💓', enabled:true },
      { slug:'pulseox',    title:'Pulse Oximeter',             url:'https://emscodesim.com/vitals/pulseox.html',    icon:'🫁', enabled:true },
      { slug:'capno',      title:'Capnography Trainer',        url:'https://emscodesim.com/vitals/capnography.html',icon:'📈', enabled:true },
      // add more here as you build them…
    ];

    // Utility: get URL params
    const q = new URLSearchParams(location.search);

    // Day-of-year in America/Denver (no libs)
    function dayOfYearInTZ(tz='America/Denver'){
      const now = new Date();
      // format a YYYY-MM-DD for that TZ
      const parts = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(now);
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const d = parts.find(p=>p.type==='day').value;
      const localMidnight = new Date(`${y}-${m}-${d}T00:00:00-07:00`); // MDT/MST offset won’t be exact across DST, but the date is correct
      // compute day-of-year by diff with Jan 1 local
      const jan1 = new Date(`${y}-01-01T00:00:00-07:00`);
      return Math.floor((localMidnight - jan1)/86400000) + 1;
    }

    function pickSim(){
      const forced = q.get('force'); // e.g., ?force=bp
      const enabled = SIMS.filter(s=>s.enabled);
      if (enabled.length === 0) return null;

      if (forced){
        const found = enabled.find(s=>s.slug===forced);
        if(found) return found;
      }

      const doy = dayOfYearInTZ('America/Denver');
      return enabled[doy % enabled.length];
    }

    function prefetchNext(){
      const enabled = SIMS.filter(s=>s.enabled);
      if(enabled.length < 2) return;
      const doy = dayOfYearInTZ('America/Denver') + 1;
      const next = enabled[doy % enabled.length];
      const link = document.createElement('link');
      link.rel = 'prefetch';
      link.href = next.url;
      document.head.appendChild(link);
    }

    function openNew(url){ window.open(url, '_blank', 'noopener'); }

    // Attempt to load in an iframe; if blocked, show fallback link list.
    function loadSim(sim){
      const nameEl = document.getElementById('simName');
      const iconEl = document.getElementById('simIcon');
      const frameWrap = document.getElementById('frameWrap');
      const iframe = document.createElement('iframe');
      iframe.src = sim.url;
      iframe.loading = 'eager';
      iframe.referrerPolicy = 'no-referrer';
      iframe.allow = 'fullscreen; autoplay; clipboard-read; clipboard-write';

      nameEl.textContent = sim.title;
      iconEl.textContent = sim.icon;

      // If site blocks embedding (X-Frame-Options/Same-Origin-Policy), onload won't fire reliably.
      // We’ll race a timeout and display a friendly fallback if needed.
      let loaded = false;
      const timeout = setTimeout(()=>{
        if(!loaded){
          frameWrap.innerHTML = `
            <div class="fallback">
              <p><strong>Heads up:</strong> This sim can’t be embedded here. Open it directly:</p>
              <p><a class="btn" href="${sim.url}" target="_blank" rel="noopener">Open ${sim.title}</a></p>
              <hr style="border-color:rgba(255,255,255,.1)">
              <p class="tiny">Or choose a different sim:</p>
              <div class="altList"></div>
            </div>`;
          const alt = document.querySelector('.altList');
          SIMS.filter(s=>s.enabled).forEach(s=>{
            const a = document.createElement('a');
            a.className = 'btn'; a.style.marginRight='8px'; a.href = `?force=${s.slug}`;
            a.textContent = `${s.icon} ${s.title}`;
            alt.appendChild(a);
          });
        }
      }, 3500);

      iframe.onload = ()=>{
        loaded = true;
        clearTimeout(timeout);
      };

      frameWrap.innerHTML = '';
      frameWrap.appendChild(iframe);

      // Analytics
      if(window.gtag){ gtag('event','daily_sim_load',{sim_slug:sim.slug, sim_title:sim.title}); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const sim = pickSim();
      if(!sim){
        document.getElementById('simName').textContent = 'No sims available';
        return;
      }
      loadSim(sim);
      prefetchNext();

      // Action buttons
      document.getElementById('openNew').addEventListener('click', ()=>openNew(sim.url));
      document.getElementById('shuffle').addEventListener('click', ()=>{
        // Quick user-triggered shuffle among enabled sims (ignores date)
        const enabled = SIMS.filter(s=>s.enabled);
        const next = enabled[(Math.floor(Math.random()*1e6)) % enabled.length];
        const url = new URL(location.href);
        url.searchParams.set('force', next.slug);
        location.href = url.toString();
      });
    });
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="brand" href="./">
        <div class="logo">
          <!-- Swap path to your actual icon -->
          <img src="./images/daily-ems-quiz-icon.png" alt="Daily EMS Quiz icon"
               onerror="this.replaceWith(Object.assign(document.createElement('div'),{textContent:'🩺',style:'font-size:20px'}))">
        </div>
        <div class="title">
          <b>Daily Sim</b>
          <div class="tiny">Loads a different mini-app each day</div>
        </div>
      </a>
      <div class="actions">
        <a id="openNew" class="btn">🔗 Open in new tab</a>
        <a id="shuffle" class="btn" title="Try a different sim now">🎲 Shuffle</a>
      </div>
    </header>

    <section class="card hero">
      <div class="simName"><span id="simIcon">🧪</span> <span id="simName">Loading…</span></div>
      <div class="tiny">Tip: add <code>?force=bp</code> (or pulse, pulseox, capno) to link to a specific sim for demos.</div>
    </section>

    <section id="frameWrap" class="frameWrap card" aria-live="polite"></section>

    <footer>
      <div>&copy; 2025 DailyEMSQuiz.com · Not affiliated with NREMT</div>
      <div style="margin-top:8px">
        <a href="https://emscodesim.com/" target="_blank" rel="noopener">Part of the EMS Code Sim training ecosystem</a>
      </div>
    </footer>
  </div>
</body>
</html>
